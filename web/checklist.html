<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Чеклист — eMigrant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<div class="screen">
  <div class="container">
    <div class="header">
      <div class="col" style="flex:1">
        <div class="h1" data-i18n="cl_title">Ваш чеклист</div>

        <!-- Заголовок прогресса и процент в одной строке -->
        <div class="row between" style="margin-top:4px">
          <span class="muted" data-i18n="cl_progress">Прогресс</span>
          <span id="pct" class="badge">0%</span>
        </div>
        <!-- А сам бар — отдельной строкой на 100% ширины -->
        <div class="progress full"><span id="bar"></span></div>
      </div>

      <div class="lang">
        <button data-lang="ru" class="active">RU</button>
        <button data-lang="ua">UA</button>
        <button data-lang="by">BY</button>
      </div>
    </div>

    <div id="path_name" class="badge">—</div>
    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <div class="tabs">
    <a class="tab" href="./translator.html" data-i18n="nav_translator">Переводчик</a>
    <a class="tab" href="./checklist.html" data-i18n="nav_checklist">Чеклист</a>
    <a class="tab" href="./consultant.html" data-i18n="nav_consultant">Консультант</a>
  </div>
</div>

<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const storage = { get(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))} };

  // i18n
  const i18n = {
    lang: storage.get('lang','ru'),
    dict:{},
    async load(lang){
      const use = lang || i18n.lang;
      try{
        const res = await fetch(`./i18n/${use}.json`, {cache:'no-store'});
        if(res.ok){ i18n.dict = await res.json(); i18n.lang = use; storage.set('lang',use); }
      }catch(e){}
      applyTexts(); highlightLang(); render();
    }
  };
  const t = (k)=> i18n.dict[k] || k;
  function applyTexts(){ $$('[data-i18n]').forEach(el=>{ const key=el.getAttribute('data-i18n'); if(i18n.dict[key]) el.textContent=i18n.dict[key]; }); document.documentElement.setAttribute('lang', i18n.lang); }
  function highlightLang(){ $$('.lang button').forEach(b=> b.classList.toggle('active', b.dataset.lang===i18n.lang)); }
  function bindLang(){ $$('.lang button').forEach(b=> b.onclick = ()=> i18n.load(b.dataset.lang)); }

  // путь и шаблоны
  function decidePath(q){
    if(q?.application_basis==='work') return 'work_basis';
    if(q?.application_basis==='study') return 'study_basis';
    if(q?.application_basis==='ukr_status') return 'ukr_basis';
    return 'work_basis'; // по умолчанию
  }
  const PATH_TITLE_KEY = {
    work_basis: 'path.work_basis',
    study_basis: 'path.study_basis',
    ukr_basis: 'path.ukr_basis'
  };
  const CHECKLIST_TEMPLATES = {
    work_basis: [
      {slug:'formular', i18n:'item.formular'},
      {slug:'supplement1', i18n:'item.supplement1'},
      {slug:'work', i18n:'item.work'},
      {slug:'photos', i18n:'item.photos'},
      {slug:'payment', i18n:'item.payment'},
      {slug:'address', i18n:'item.address'},
      {slug:'insurance', i18n:'item.insurance'},
      {slug:'tax-certificate', i18n:'item.tax_certificate'},
      {slug:'pit', i18n:'item.pit'}
    ],
    study_basis: [
      {slug:'formular', i18n:'item.formular'},
      {slug:'student-zaswiadczenie', i18n:'item.student_zaswiadczenie'},
      {slug:'photos', i18n:'item.photos'},
      {slug:'payment', i18n:'item.payment'},
      {slug:'address', i18n:'item.address'},
      {slug:'student-insurance', i18n:'item.student_insurance'},
      {slug:'bank-statement', i18n:'item.bank_statement'}
    ],
    ukr_basis: [
      {slug:'formular', i18n:'item.formular'},
      {slug:'photos', i18n:'item.photos'},
      {slug:'payment', i18n:'item.payment'},
      {slug:'pesel-ukr', i18n:'item.pesel_ukr'}
    ]
  };
  function moduleLink(slug){
    if(slug==='student-zaswiadczenie') return './module-student-zaswiadczenie.html';
    if(slug==='choose-basis') return './module-no-status-basis.html';
    if(slug==='address') return './module-address.html';
    if(slug==='photos') return './module-photos.html'; // ⬅️ модуль фотографий
    if(slug==='formular') return './module-formular.html'; // ⬅️ модуль формуляра
    if(slug==='supplement1') return './module-supplement1.html'; // ⬅️ модуль дополнения №1
    if(slug==='payment') return './module-payment.html'; // ⬅️ модуль оплаты
    if(slug==='work') return './module-work.html'; // ⬅️ модуль работы
    if(slug==='insurance') return './module-insurance.html'; // ⬅️ модуль страховки
    if(slug==='tax-certificate') return './module-tax-certificate.html'; // ⬅️ модуль справки о налогах
    if(slug==='pit') return './module-pit.html'; // ⬅️ модуль PIT
    if(slug==='bank-statement') return './module-bank-statement.html'; // ⬅️ модуль справки о состоянии счета
    if(slug==='student-insurance') return './module-student-insurance.html'; // ⬅️ модуль страховки для студентов
    if(slug==='pesel-ukr') return './module-ukr-pesel.html'; // ⬅️ модуль UKR PESEL
    return '#todo';
  }
  function computeProgress(items){ const done = items.filter(x=>x.done).length; return Math.round((done / Math.max(items.length,1)) * 100); }

  // состояние
  let pathId = 'work_basis';
  let items = [];

  function ensureChecklist(){
    const key = 'checklist_'+pathId;
    const stored = storage.get(key, null);
    if(stored){ items = stored; return; }
    items = (CHECKLIST_TEMPLATES[pathId]||[]).map(x=>({ ...x, done:false }));
    storage.set(key, items);
  }

  function render(){
    $('#path_name').textContent = t(PATH_TITLE_KEY[pathId] || pathId);

    const list = $('#list');
    list.innerHTML = '';
    items.forEach((it, idx)=>{
      const row = document.createElement('div');
      row.className = 'item';

      // Показываем новое имя для пункта address
      let title = it.i18n ? t(it.i18n) : (it.title||'');
      if (it.slug === 'address') title = 'Подтверждение адреса';

      const link = moduleLink(it.slug);
      row.innerHTML = `
        <div class="checkbox ${it.done?'done':''}" data-idx="${idx}">${it.done?'✓':''}</div>
        <div class="col" style="flex:1">
          <a href="${link}"><b>${title}</b></a>
          <small class="muted">${link.includes('#todo')?'(…)':''}</small>
        </div>
      `;
      list.appendChild(row);
    });

    const pct = computeProgress(items);
    $('#bar').style.width = pct + '%';
    $('#pct').textContent = pct + '%';

    $$('.checkbox').forEach(cb=>{
      cb.onclick = ()=>{
        const i = Number(cb.dataset.idx);
        items[i].done = !items[i].done;
        storage.set('checklist_'+pathId, items);
        render();
      };
    });
  }

  function initTG(){ const tg = window.Telegram && window.Telegram.WebApp; if(!tg) return; tg.expand(); tg.ready(); }

  async function boot(){
    initTG();
    bindLang();
    await i18n.load(storage.get('lang','ru'));

    const q = storage.get('questionnaire', {});
    pathId = storage.get('last_path', null) || decidePath(q);
    ensureChecklist();
    render();
  }

  document.addEventListener('DOMContentLoaded', boot);
  window.addEventListener('pageshow', boot);
})();
</script>
</body>
</html>
