<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Анкета — eMigrant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    /* Страховка от «не кликается» в WebView */
    .screen,.container,.footer,.lang,button,.btn,select,input,textarea { pointer-events:auto; }
    .lang{position:relative; z-index:5}
    .footer{position:sticky; bottom:0; z-index:4}
  </style>
</head>
<body>
<div class="screen">
  <div class="container">
    <div class="header">
      <div class="h1" data-i18n="q_title">Анкета</div>
      <div class="lang">
        <button data-lang="ru" class="active">RU</button>
        <button data-lang="ua">UA</button>
        <button data-lang="by">BY</button>
      </div>
    </div>

    <div class="col">
      <label class="col">
        <span>Имя (латиницей)</span>
        <input id="first_name" class="input" placeholder="Ivan" />
      </label>
      <label class="col">
        <span>Фамилия (латиницей)</span>
        <input id="last_name" class="input" placeholder="Ivanov" />
      </label>

      <label class="col">
        <span data-i18n="q_citizenship">Гражданство</span>
        <select id="citizenship" class="input">
          <option value="ua">Украина</option>
          <option value="by">Беларусь</option>
          <option value="ru">Россия</option>
        </select>
      </label>

      <label class="col">
        <span data-i18n="q_status">Текущий статус</span>
        <select id="status" class="input">
          <option value="pesel_ukr">PESEL-UKR</option>
          <option value="asylum">Беженство / международная защита</option>
          <option value="karta_czasowa">Karta pobytu czasowego (действующая)</option>
          <option value="student">Учащийся</option>
          <option value="no_status">Нет статуса</option>
        </select>
      </label>

      <label class="col">
        <span>Воеводство</span>
        <select id="voivodeship" class="input">
          <option value="dolnoslaskie">Dolnośląskie</option>
          <option value="kujawsko_pomorskie">Kujawsko-Pomorskie</option>
          <option value="lubelskie">Lubelskie</option>
          <option value="lubuskie">Lubuskie</option>
          <option value="lodzkie">Łódzkie</option>
          <option value="malopolskie">Małopolskie</option>
          <option value="mazowieckie">Mazowieckie</option>
          <option value="opolskie">Opolskie</option>
          <option value="podkarpackie">Podkarpackie</option>
          <option value="podlaskie">Podlaskie</option>
          <option value="pomorskie">Pomorskie</option>
          <option value="slaskie">Śląskie</option>
          <option value="swietokrzyskie">Świętokrzyskie</option>
          <option value="warminsko_mazurskie">Warmińsko-Mazurskie</option>
          <option value="wielkopolskie">Wielkopolskie</option>
          <option value="zachodniopomorskie">Zachodniopomorskie</option>
        </select>
      </label>

      <label class="col">
        <span>Уровень заработка</span>
        <select id="income_level" class="input">
          <option value="lt_4700">меньше 4700 zł</option>
          <option value="gt_4700">больше 4700 zł</option>
        </select>
      </label>

      <div id="student_extra" class="card hidden">
        <div class="h2">Данные для учащегося</div>
        <label class="col"><span>Учебное заведение</span><input id="stud_inst" class="input" placeholder="UW / PW / ..."/></label>
        <label class="col"><span>Документ</span>
          <select id="stud_doc" class="input">
            <option value="o_przyjeciu">Zaświadczenie o przyjęciu</option>
            <option value="o_studiowaniu">Zaświadczenie o studiowaniu</option>
          </select>
        </label>
        <div class="row">
          <label class="col" style="flex:1"><span>Начало (ДД.ММ.ГГГГ)</span><input id="stud_start" class="input" placeholder="01.10.2025"/></label>
          <label class="col" style="flex:1"><span>Окончание (ДД.ММ.ГГГГ)</span><input id="stud_end" class="input" placeholder="30.06.2026"/></label>
        </div>
      </div>

      <div id="nostatus_extra" class="card hidden">
        <div class="h2">Если нет статуса</div>
        <label class="col"><span>Дата последнего въезда (ДД.ММ.ГГГГ)</span><input id="ns_entry" class="input" placeholder="15.08.2025"/></label>
        <label class="col"><span>Есть оффер на работу?</span>
          <select id="ns_offer" class="input">
            <option value="no">Нет</option><option value="yes">Да</option>
          </select>
        </label>
      </div>
    </div>

    <div class="footer">
      <div class="row">
        <button id="prev" type="button" class="btn secondary" data-i18n="q_prev">Назад</button>
        <button id="next" type="button" class="btn full" data-i18n="q_preview">Просмотреть ответы</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // --- helpers (встроенные, без импортов) ---
  const $ = (sel, root=document)=> root.querySelector(sel);
  const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
  const storage = {
    get(k, d=null){ try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{ return d } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
  };
  const isLatinName = s => /^[A-Za-z\s\-']{2,}$/.test(String(s||'').trim());
  const isDDMMYYYY = s => /^([0-2]\d|3[01])\.(0\d|1[0-2])\.(19|20)\d{2}$/.test(String(s||'').trim());

  // --- i18n минималка ---
  const i18n = {
    lang: storage.get('lang','ru'),
    dict: {},
    async load(lang){
      try{
        const res = await fetch(`./i18n/${lang}.json`, {cache:'no-store'});
        if(res.ok){ i18n.dict = await res.json(); i18n.lang = lang; storage.set('lang', lang); }
      }catch(e){ /* fallback: RU по умолчанию */ }
      apply();
    }
  };
  function apply(){
    $$('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if(i18n.dict[key]) el.textContent = i18n.dict[key];
    });
    // подсветка активной кнопки языка
    $$('.lang button').forEach(b=> b.classList.toggle('active', b.dataset.lang === i18n.lang));
    document.documentElement.setAttribute('lang', i18n.lang);
  }
  function bindLang(){
    $$('.lang button').forEach(b=>{
      b.onclick = async ()=> { await i18n.load(b.dataset.lang); };
    });
  }

  // --- Telegram WebApp init (минимально) ---
  (function initTelegram(){
    const tg = window.Telegram && window.Telegram.WebApp;
    if(!tg) return;
    tg.expand(); tg.ready();
    tg.onEvent && tg.onEvent('themeChanged', ()=>{/* темы handled CSS */});
  })();

  // --- логика анкеты ---
  function toggleExtras(){
    const st = $('#status').value;
    $('#student_extra').classList.toggle('hidden', st!=='student');
    $('#nostatus_extra').classList.toggle('hidden', st!=='no_status');
  }

  function bindControls(){
    $('#status').addEventListener('change', toggleExtras);
    toggleExtras();

    // кнопки
    $('#prev').onclick = ()=> history.back();
    $('#next').onclick = ()=>{
      const first = $('#first_name').value.trim();
      const last  = $('#last_name').value.trim();
      if(!isLatinName(first) || !isLatinName(last)){
        alert('Имя/фамилия: только латиница, минимум 2 символа'); return;
        }

      const q = {
        first, last,
        citizenship: $('#citizenship').value,
        status: $('#status').value,
        voivodeship: $('#voivodeship').value,
        income_level: $('#income_level').value
      };

      if(q.status==='student'){
        q.student = {
          inst: $('#stud_inst').value.trim(),
          doc: $('#stud_doc').value,
          start: $('#stud_start').value.trim(),
          end: $('#stud_end').value.trim()
        };
        if(q.student.start && !isDDMMYYYY(q.student.start)){ alert('Дата начала: формат ДД.ММ.ГГГГ'); return; }
        if(q.student.end && !isDDMMYYYY(q.student.end)){ alert('Дата окончания: формат ДД.ММ.ГГГГ'); return; }
      }
      if(q.status==='no_status'){
        q.no_status = {
          last_entry: $('#ns_entry').value.trim(),
          has_offer: $('#ns_offer').value==='yes'
        };
        if(q.no_status.last_entry && !isDDMMYYYY(q.no_status.last_entry)){ alert('Дата последнего въезда: формат ДД.ММ.ГГГГ'); return; }
      }

      storage.set('questionnaire', q);
      location.href = './questionnaire-preview.html';
    };
  }

  // --- загрузка страницы/языка и бинды ---
  async function boot(){
    await i18n.load(storage.get('lang','ru'));
    bindLang();
    bindControls();
  }

  // при обычной загрузке
  document.addEventListener('DOMContentLoaded', boot);
  // при возврате из истории (bfcache)
  window.addEventListener('pageshow', boot);
})();
</script>
</body>
</html>
