<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Анкета — eMigrant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .lang{position:relative;z-index:5}
    .footer{position:sticky;bottom:0;z-index:4}
    button,.btn,select,input,textarea{pointer-events:auto;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  </style>
</head>
<body>
<div class="screen">
  <div class="container">
    <div class="header">
      <div class="h1" data-i18n="q_title">Анкета</div>
      <div class="lang">
        <button data-lang="ru" class="active">RU</button>
        <button data-lang="ua">UA</button>
        <button data-lang="by">BY</button>
      </div>
    </div>

    <div class="col">
      <label class="col">
        <span data-i18n="q_name">Имя (латиницей)</span>
        <input id="first_name" class="input" placeholder="Ivan" />
      </label>

      <label class="col">
        <span data-i18n="q_surname">Фамилия (латиницей)</span>
        <input id="last_name" class="input" placeholder="Ivanov" />
      </label>

      <label class="col">
        <span data-i18n="q_citizenship">Гражданство</span>
        <select id="citizenship" class="input"></select>
      </label>


      <label class="col">
        <span data-i18n="q_voivodeship">Воеводство</span>
        <select id="voivodeship" class="input">
          <option value="dolnoslaskie">Dolnośląskie</option>
          <option value="kujawsko_pomorskie">Kujawsko-Pomorskie</option>
          <option value="lubelskie">Lubelskie</option>
          <option value="lubuskie">Lubuskie</option>
          <option value="lodzkie">Łódzkie</option>
          <option value="malopolskie">Małopolskie</option>
          <option value="mazowieckie">Mazowieckie</option>
          <option value="opolskie">Opolskie</option>
          <option value="podkarpackie">Podkarpackie</option>
          <option value="podlaskie">Podlaskie</option>
          <option value="pomorskie">Pomorskie</option>
          <option value="slaskie">Śląskie</option>
          <option value="swietokrzyskie">Świętokrzyskie</option>
          <option value="warminsko_mazurskie">Warmińsko-Mazurskie</option>
          <option value="wielkopolskie">Wielkopolskie</option>
          <option value="zachodniopomorskie">Zachodniopomorskie</option>
        </select>
      </label>

      <label class="col">
        <span data-i18n="q_income">Уровень дохода в месяц брутто</span>
        <select id="income_level" class="input"></select>
      </label>

      <label class="col">
        <span data-i18n="q_application_basis">Я хочу податься на карту на основании</span>
        <select id="application_basis" class="input"></select>
      </label>


    </div>

    <div class="footer">
      <div class="row">
        <button id="next" type="button" class="btn full" data-i18n="q_preview">Просмотреть ответы</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const storage = {
    get(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},
    set(k,v){localStorage.setItem(k,JSON.stringify(v))}
  };

  const i18n = {
    lang: storage.get('lang','ru'),
    dict:{},
    async load(lang){
      let use = lang || i18n.lang;
      try{
        const res = await fetch(`./i18n/${use}.json`, {cache:'no-store'});
        if(res.ok) { i18n.dict = await res.json(); i18n.lang = use; storage.set('lang',use); }
      }catch(e){}
      applyTexts();
      mountSelects(); // чтобы подписи и варианты локализовались
      highlightLang();
    }
  };
  const t = (k)=> i18n.dict[k] || k;

  function applyTexts(){
    $$('[data-i18n]').forEach(el=>{
      const k = el.getAttribute('data-i18n');
      if(i18n.dict[k]) el.textContent = i18n.dict[k];
    });
    document.documentElement.setAttribute('lang', i18n.lang);
  }
  function highlightLang(){
    $$('.lang button').forEach(b=> b.classList.toggle('active', b.dataset.lang===i18n.lang));
  }
  function bindLang(){
    $$('.lang button').forEach(b=>{
      b.onclick = ()=> i18n.load(b.dataset.lang);
    });
  }

  function mountSelects(){
    // Citizenship
    const cit = $('#citizenship');
    cit.innerHTML = `
      <option value="ua">${t('cit.ua')}</option>
      <option value="by">${t('cit.by')}</option>
      <option value="ru">${t('cit.ru')}</option>
    `;

    // Income
    const inc = $('#income_level');
    inc.innerHTML = `
      <option value="lt_4700">${t('income.lt4700')}</option>
      <option value="4700_12000">${t('income.4700_12000')}</option>
      <option value="gt_12000">${t('income.gt12000')}</option>
    `;

    // Application Basis
    const basis = $('#application_basis');
    basis.innerHTML = `
      <option value="work">${t('basis.work')}</option>
      <option value="study">${t('basis.study')}</option>
      <option value="ukr_status">${t('basis.ukr_status')}</option>
    `;
  }

  // Validation
  const isLatinName = s => /^[A-Za-z\s\-']{2,}$/.test(String(s||'').trim());
  const isDDMMYYYY = s => /^([0-2]\d|3[01])\.(0\d|1[0-2])\.(19|20)\d{2}$/.test(String(s||'').trim());

  function toggleExtras(){
    // Дополнительные поля убраны
  }

  function bindControls(){
    $('#application_basis').addEventListener('change', toggleExtras);
    toggleExtras();

    $('#next').onclick = ()=>{
      const first = $('#first_name').value.trim();
      const last  = $('#last_name').value.trim();
      if(!isLatinName(first) || !isLatinName(last)){
        alert(t('err_name_latin')); return;
      }

      const q = {
        first, last,
        citizenship: $('#citizenship').value,
        voivodeship: $('#voivodeship').value,
        income_level: $('#income_level').value,
        application_basis: $('#application_basis').value
      };


      storage.set('questionnaire', q);
      location.href = './questionnaire-preview.html';
    };
  }

  function initTG(){
    const tg = window.Telegram && window.Telegram.WebApp;
    if(!tg) return;
    tg.expand(); tg.ready();
  }

  async function boot(){
    initTG();
    bindLang();
    await i18n.load(storage.get('lang','ru'));
    bindControls();
  }
  document.addEventListener('DOMContentLoaded', boot);
  window.addEventListener('pageshow', boot);
})();
</script>
</body>
</html>
