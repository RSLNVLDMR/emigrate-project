<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Подтверждение адреса — eMigrant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<div class="screen">
  <div class="container">
    <div class="header">
      <div class="h1">Подтверждение адреса</div>
      <div class="lang">
        <button data-lang="ru" class="active">RU</button>
        <button data-lang="ua">UA</button>
        <button data-lang="by">BY</button>
      </div>
    </div>

    <!-- Общее описание -->
    <div class="card">
      <div class="h2">Зачем это нужно</div>
      <div class="p muted">
        Этот модуль помогает подготовить и проверить документ, подтверждающий адрес проживания
        в Польше (договор аренды, мелдунек, подтверждение собственника и т.п.).
      </div>
    </div>

    <!-- Как оформить (плейсхолдеры сценариев) -->
    <div class="card" style="margin-top:12px">
      <div class="h2">Как оформить</div>
      <div class="p muted">Дальше здесь будут разные сценарии оформления в зависимости от вашей ситуации:</div>
      <ul class="p muted" style="margin-top:4px">
        <li>У вас <b>обычный договор аренды</b></li>
        <li>У вас <b>умова найму оказионального</b></li>
        <li>Нужно получить <b>мелдунек</b></li>
        <li>Вы — <b>владелец жилья</b></li>
        <li>Сейчас <b>нет легального жилья</b> — временные варианты</li>
      </ul>
      <div class="p muted">Сценарий подберём по ответам анкеты; пока здесь — заглушка.</div>
    </div>

    <!-- Загрузка и проверка -->
    <div class="card" style="margin-top:12px">
      <div class="h2">У меня уже есть документ</div>

      <div class="col" style="gap:10px">
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <label class="muted">Тип документа:</label>
          <select id="docType" class="input" style="max-width:320px">
            <option value="lease_standard">Договор аренды (обычный)</option>
            <option value="lease_okazjonalna">Договор аренды (okazjonalna)</option>
            <option value="meldunek">Мелдунек (zaświadczenie o zameldowaniu)</option>
            <option value="owner">Вы — собственник</option>
            <option value="other">Другое</option>
          </select>
        </div>

        <div class="row" style="gap:8px;align-items:flex-start;flex-wrap:wrap">
          <input id="file" type="file" accept="image/*,application/pdf" class="input" style="max-width:320px" />
          <button id="checkBtn" class="btn">Проверить</button>
          <button id="rushBtn" class="btn secondary" disabled>Ускорить (5 мин)</button>
        </div>

        <!-- Превью файла -->
        <div id="fileInfo" class="card" style="display:none;background:transparent;border-style:dashed">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="col" style="gap:2px">
              <div id="fileName" class="p"></div>
              <small id="fileMeta" class="muted"></small>
            </div>
            <button id="removeFile" class="btn secondary">Удалить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Результат / Что исправить / Извлечённые поля -->
    <div id="resultCard" class="card" style="margin-top:12px;display:none">
      <div class="h2">Результат</div>
      <div id="resultMsg" class="p"></div>

      <hr />

      <div class="h2">Что исправить</div>
      <ul id="issues" class="p" style="margin-top:4px"></ul>

      <hr />

      <div class="h2">Извлечённые поля</div>
      <div id="extracted" class="p" style="white-space:pre-wrap;font-family:ui-monospace, Menlo, Consolas, monospace;background:var(--ink);border:1px solid var(--line);border-radius:12px;padding:12px"></div>

      <small class="muted" style="display:block;margin-top:8px">Сообщение также придёт в бота.</small>
    </div>

  </div>

  <div class="tabs">
    <a class="tab" href="./translator.html">Переводчик</a>
    <a class="tab" href="./checklist.html">Чеклист</a>
    <a class="tab" href="./consultant.html">Консультант</a>
  </div>
</div>

<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);

  // ===== helper =====
  function fmtBytes(n){
    if(!n && n!==0) return "";
    const u=["Б","КБ","МБ","ГБ"]; let i=0; let v=n;
    while(v>1024 && i<u.length-1){ v/=1024; i++; }
    return v.toFixed(v<10?1:0)+" "+u[i];
  }
  function humanFields(fields){
    const map = {
      full_name: "ФИО",
      address: "Адрес",
      postal_code: "Индекс",
      city: "Город",
      doc_date: "Дата документа",
      valid_from: "Действует с",
      valid_to: "Действует до",
      issuer: "Орган, выдавший документ",
      signatures_present: "Подписи/печати"
    };
    const order = ["full_name","address","postal_code","city","doc_date","valid_from","valid_to","issuer","signatures_present"];
    const lines = [];
    lines.push("{");
    order.forEach((k)=>{
      const label = map[k] || k;
      let val = fields && (fields[k]!==undefined ? fields[k] : null);
      if (val === null || val === undefined || val === "") val = "—";
      if (typeof val === "boolean") val = val ? "да" : "нет";
      lines.push(`  "${label}": ${typeof val==="string" ? `"${String(val)}"` : val}`);
    });
    lines.push("}");
    return lines.join("\n");
  }
  function verdictMessage(v, isProof){
    if(v==="fail") {
      if(isProof === false) return "Документ не является подтверждением адреса.";
      return "Документ содержит ошибки и не может быть принят.";
    }
    if(v==="pass") return "Документ подтверждает адрес проживания.";
    return "Не удалось уверенно определить корректность документа.";
  }
  function renderIssues(list){
    const box = $("#issues");
    box.innerHTML = "";
    if(!list || !list.length){
      const li = document.createElement("li");
      li.className = "muted";
      li.textContent = "Ошибок не найдено.";
      box.appendChild(li);
      return;
    }
    list.forEach(e=>{
      const li = document.createElement("li");
      const sev = e.severity ? String(e.severity).toUpperCase() : "";
      li.innerHTML = `<b>${e.title || "Ошибка"}</b> · ${sev}<br/><span class="muted">${e.detail || ""}</span>`;
      box.appendChild(li);
    });
  }

  // ===== upload state =====
  let chosenFile = null;
  const fileInput = $("#file");
  const fileInfo = $("#fileInfo");
  const fileName = $("#fileName");
  const fileMeta = $("#fileMeta");

  fileInput.onchange = () => {
    const f = fileInput.files && fileInput.files[0];
    chosenFile = f || null;
    if (chosenFile){
      fileInfo.style.display = "block";
      fileName.textContent = chosenFile.name || "Файл";
      fileMeta.textContent = `${chosenFile.type || "—"} · ${fmtBytes(chosenFile.size||0)}`;
    } else {
      fileInfo.style.display = "none";
      fileName.textContent = ""; fileMeta.textContent = "";
      $("#resultCard").style.display = "none";
    }
  };
  $("#removeFile").onclick = () => {
    chosenFile = null;
    fileInput.value = "";
    fileInfo.style.display = "none";
    $("#resultCard").style.display = "none";
  };

  // ===== check =====
  $("#checkBtn").onclick = async ()=>{
    if(!chosenFile){
      alert("Сначала загрузите файл.");
      return;
    }
    const docType = $("#docType").value || "other";
    const fd = new FormData();
    fd.append("docType", docType);
    fd.append("file", chosenFile);

    $("#checkBtn").disabled = true;

    try{
      const res = await fetch("/api/verify-address", { method:"POST", body: fd });
      const data = await res.json();

      // Результат — всегда есть
      const msg = verdictMessage(data.verdict, data.is_proof_of_address);
      $("#resultMsg").textContent = msg;

      // Ошибки — всегда показываем (или «Ошибок не найдено»)
      renderIssues(data.errors || []);

      // Извлечённые поля — человекочитаемые подписи
      const pretty = humanFields(data.fieldsExtracted || {});
      $("#extracted").textContent = pretty;

      $("#resultCard").style.display = "block";
    }catch(e){
      alert("Не удалось проверить документ. Попробуйте ещё раз.");
    }finally{
      $("#checkBtn").disabled = false;
    }
  };

  // TG init
  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg) { tg.expand(); tg.ready(); }
})();
</script>
</body>
</html>
