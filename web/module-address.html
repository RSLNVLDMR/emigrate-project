<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ ‚Äî eMigrant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<div class="screen">
  <div class="container">
    <div class="header">
      <div class="h1" data-i18n="address_title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞</div>
      <div class="lang">
        <button data-lang="ru" class="active">RU</button>
        <button data-lang="ua">UA</button>
        <button data-lang="by">BY</button>
      </div>
    </div>

    <!-- –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è -->
    <div class="card">
      <div class="p muted" data-i18n="address_description">
        –ü–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π –∞–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è
        –≤ –ü–æ–ª—å—à–µ (–¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã, –º–µ–ª–¥—É–Ω–µ–∫, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –∏ —Ç.–ø.).
      </div>
    </div>

    <!-- –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å (–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤) -->
    <div class="card" style="margin-top:12px">
      <div class="h2" data-i18n="address_how_to_apply">–ö–∞–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–æ–π–¥–µ—Ç</div>
      <div class="p muted" data-i18n="address_scenarios_desc">–î–∞–ª—å—à–µ –∑–¥–µ—Å—å –±—É–¥—É—Ç —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏:</div>
      <ul class="p muted" style="margin-top:4px">
        <li data-i18n="address_scenario_1">–£ –≤–∞—Å <b>–æ–±—ã—á–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã</b></li>
        <li data-i18n="address_scenario_2">–£ –≤–∞—Å <b>—É–º–æ–≤–∞ –Ω–∞–π–º—É –æ–∫–∞–∑–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ</b></li>
        <li data-i18n="address_scenario_3">–£ –≤–∞—Å –µ—Å—Ç—å <b>–º–µ–ª—å–¥—É–Ω–µ–∫</b></li>
        <li data-i18n="address_scenario_4">–í—ã ‚Äî <b>–≤–ª–∞–¥–µ–ª–µ—Ü –∂–∏–ª—å—è</b></li>
        <li data-i18n="address_scenario_5">–ï—Å–ª–∏ —É –≤–∞—Å <b>–Ω–µ—Ç –ª–µ–≥–∞–ª—å–Ω–æ–≥–æ –∂–∏–ª—å—è</b> ‚Äî <b>–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º</b> ‚Äî –º—ã —Å–º–æ–∂–µ–º –ø–æ–º–æ—á—å</li>
      </ul>
    </div>

    <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å AI -->
    <div class="card" style="margin-top:12px">
      <div class="h2" data-i18n="address_ai_check_title">ü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å AI</div>
      <div class="p muted" data-i18n="address_ai_check_desc">
        –ù–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞—à –¥–æ–∫—É–º–µ–Ω—Ç, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π –∞–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è.
      </div>

      <div class="col" style="gap:10px">
        <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å AI -->
        <div class="row" style="gap:8px;align-items:flex-start;flex-wrap:wrap">
          <button id="checkWithAI" class="btn btn-primary" data-i18n="address_check_with_ai">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å AI</button>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
        <div id="statusRow" class="row" style="gap:8px;align-items:center;display:none">
          <span id="statusDot" style="width:10px;height:10px;border-radius:50%;background:var(--muted);display:inline-block"></span>
          <span id="statusText" class="muted"></span>
        </div>
      </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç / –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å / –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –ø–æ–ª—è -->
    <div id="resultCard" class="card" style="margin-top:12px;display:none">
      <div class="h2">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
      <div id="resultMsg" class="p"></div>

      <hr />

      <div class="h2">–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å</div>
      <ul id="issues" class="p" style="margin-top:4px"></ul>

      <hr />

      <div class="h2">–ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –ø–æ–ª—è</div>
      <!-- —Å–∫—Ä—ã—Ç–æ –ø–æ –¥–µ—Ñ–æ–ª—Ç—É, —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
      <details id="extractedWrap" style="background:var(--ink);border:1px solid var(--line);border-radius:12px;">
        <summary id="extractedSummary" class="p" style="cursor:pointer;padding:12px">
          –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –ø–æ–ª—è
        </summary>
        <div id="extracted" class="p" style="padding:12px;border-top:1px solid var(--line);white-space:pre-wrap"></div>
      </details>

      <small class="muted" style="display:block;margin-top:8px">–°–æ–æ–±—â–µ–Ω–∏–µ —Ç–∞–∫–∂–µ –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç–∞.</small>
    </div>

  </div>

  <div class="tabs">
    <a class="tab" href="./translator.html">–ü–µ—Ä–µ–≤–æ–¥—á–∏–∫</a>
    <a class="tab" href="./checklist.html">–ß–µ–∫–ª–∏—Å—Ç</a>
    <a class="tab" href="./consultant.html">–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</a>
  </div>
</div>

<!-- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π PDF-—Ñ–æ–ª–ª–±—ç–∫: —Ä–µ–Ω–¥–µ—Ä –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã PDF –≤ PNG -->
<script src="./pdf-client-fallback.js" defer></script>

<script>
  (function(){
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>r.querySelectorAll(s);

  // ===== helper =====
  function fmtBytes(n){
    if(!n && n!==0) return "";
    const u=["–ë","–ö–ë","–ú–ë","–ì–ë"]; let i=0; let v=n;
    while(v>1024 && i<u.length-1){ v/=1024; i++; }
    return v.toFixed(v<10?1:0)+" "+u[i];
  }
  // –ß–ï–õ–û–í–ï–ö–û–ß–ò–¢–ê–ï–ú–´–ô –≤—ã–≤–æ–¥ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫/—Å–∫–æ–±–æ–∫
  function humanFields(fields){
    const map = {
      full_name: "–§–ò–û",
      address: "–ê–¥—Ä–µ—Å",
      postal_code: "–ò–Ω–¥–µ–∫—Å",
      city: "–ì–æ—Ä–æ–¥",
      doc_date: "–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞",
      valid_from: "–î–µ–π—Å—Ç–≤—É–µ—Ç —Å",
      valid_to: "–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ",
      issuer: "–û—Ä–≥–∞–Ω, –≤—ã–¥–∞–≤—à–∏–π –¥–æ–∫—É–º–µ–Ω—Ç",
      signatures_present: "–ü–æ–¥–ø–∏—Å–∏/–ø–µ—á–∞—Ç–∏"
    };
    const order = ["full_name","address","postal_code","city","doc_date","valid_from","valid_to","issuer","signatures_present"];
    const lines = [];
    order.forEach((k)=>{
      const label = map[k] || k;
      let val = fields && (fields[k]!==undefined ? fields[k] : null);
      if (val === null || val === undefined || val === "") val = "‚Äî";
      if (typeof val === "boolean") val = val ? "–¥–∞" : "–Ω–µ—Ç";
      lines.push(`${label}: ${val}`);
    });
    return lines.join("\n");
  }
  function verdictMessage(v, isProof){
    if(v==="fail") {
      if(isProof === false) return "–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –∞–¥—Ä–µ—Å–∞.";
      return "–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–Ω—è—Ç.";
    }
    if(v==="pass") return "–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∞–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è.";
    return "–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ—Ä–µ–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞.";
  }
  function renderIssues(list){
    const box = $("#issues");
    box.innerHTML = "";
    if(!list || !list.length){
      const li = document.createElement("li");
      li.className = "muted";
      li.textContent = "–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
      box.appendChild(li);
      return;
    }
    list.forEach(e=>{
      const li = document.createElement("li");
      const sev = e.severity ? String(e.severity).toUpperCase() : "";
      li.innerHTML = `<b>${e.title || "–û—à–∏–±–∫–∞"}</b> ¬∑ ${sev}<br/><span class="muted">${e.detail || ""}</span>`;
      box.appendChild(li);
    });
  }

  // ===== —Å—Ç–∞—Ç—É—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ =====
  const statusRow = $("#statusRow");
  const statusDot = $("#statusDot");
  const statusText = $("#statusText");
  function setStatus(type, text){
    const color = type==="ok" ? "var(--ok)"
                : type==="warn" ? "var(--warn)"
                : type==="error" ? "var(--danger)"
                : type==="checking" ? "var(--warn)"
                : "var(--muted)";
    statusDot.style.background = color;
    statusText.textContent = text || "";
    statusRow.style.display = text ? "flex" : "none";
  }

  // ===== AI check button =====
  $("#checkWithAI").onclick = () => {
    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è AI –ø—Ä–æ–≤–µ—Ä–∫–∏
    alert('–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å AI –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!');
  };


  // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ summary –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏
  const det = document.getElementById("extractedWrap");
  const sum = document.getElementById("extractedSummary");
  det?.addEventListener("toggle", ()=>{
    sum.textContent = det.open ? "–°–∫—Ä—ã—Ç—å –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –ø–æ–ª—è" : "–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –ø–æ–ª—è";
  });

  // TG init
  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg) { tg.expand(); tg.ready(); }

  // ===== i18n system =====
  let i18n = {
    lang: 'ru',
    dict: {},
    async load(lang) {
      try {
        const res = await fetch(`./i18n/${lang}.json`);
        this.dict = await res.json();
        this.lang = lang;
        localStorage.setItem('lang', lang);
        this.applyTexts();
      } catch (e) {
        console.error('Failed to load translations:', e);
      }
    },
    applyTexts() {
      $$('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (this.dict[key]) {
          el.innerHTML = this.dict[key];
        }
      });
      document.documentElement.setAttribute('lang', this.lang);
    }
  };

  // Language switching
  function bindLang() {
    $$('.lang button').forEach(b => {
      b.onclick = async () => {
        $$('.lang button').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        await i18n.load(b.dataset.lang);
        localStorage.setItem('lang', b.dataset.lang);
      };
    });
  }


  function highlightLang() {
    $$('.lang button').forEach(b => b.classList.toggle('active', b.dataset.lang === i18n.lang));
  }

  // Initialize
  async function initI18n() {
    const savedLang = localStorage.getItem('lang') || 'ru';
    await i18n.load(savedLang);
    highlightLang();
    bindLang();
  }

  // Make functions global
  window.$ = $;
  window.$$ = $$;
  window.i18n = i18n;

  // Initialize on load
  document.addEventListener('DOMContentLoaded', initI18n);
})();
</script>
</body>
</html>
