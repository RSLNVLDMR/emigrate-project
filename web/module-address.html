<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Подтверждение адреса — eMigrant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<div class="screen">
  <div class="container">
    <div class="header">
      <div class="h1">Подтверждение адреса</div>
      <div class="lang">
        <button data-lang="ru" class="active">RU</button>
        <button data-lang="ua">UA</button>
        <button data-lang="by">BY</button>
      </div>
    </div>

    <!-- Общее описание -->
    <div class="card">
      <div class="h2">Зачем это нужно</div>
      <div class="p muted">
        Этот модуль помогает подготовить и проверить документ, подтверждающий адрес проживания
        в Польше (договор аренды, мелдунек, подтверждение собственника и т.п.).
      </div>
    </div>

    <!-- Как оформить (плейсхолдеры сценариев) -->
    <div class="card" style="margin-top:12px">
      <div class="h2">Как оформить</div>
      <div class="p muted">Дальше здесь будут разные сценарии оформления в зависимости от вашей ситуации:</div>
      <ul class="p muted" style="margin-top:4px">
        <li>У вас <b>обычный договор аренды</b></li>
        <li>У вас <b>умова найму оказионального</b></li>
        <li>Нужно получить <b>мелдунек</b></li>
        <li>Вы — <b>владелец жилья</b></li>
        <li>Сейчас <b>нет легального жилья</b> — временные варианты</li>
      </ul>
      <div class="p muted">Сценарий подберём по ответам анкеты; пока здесь — заглушка.</div>
    </div>

    <!-- Загрузка и проверка -->
    <div class="card" style="margin-top:12px">
      <div class="h2">У меня уже есть документ</div>

      <div class="col" style="gap:10px">
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <label class="muted">Тип документа:</label>
          <select id="docType" class="input" style="max-width:320px">
            <option value="lease_standard">Договор аренды (обычный)</option>
            <option value="lease_okazjonalna">Договор аренды (okazjonalna)</option>
            <option value="meldunek">Мелдунек (zaświadczenie o zameldowaniu)</option>
            <option value="owner">Вы — собственник</option>
            <option value="other">Другое</option>
          </select>
        </div>

        <!-- Кастомная кнопка выбора файла + скрытый input -->
        <div class="row" style="gap:8px;align-items:flex-start;flex-wrap:wrap">
          <input id="file" type="file" accept="image/*,application/pdf" class="hidden" />
          <button id="pickFileBtn" class="btn secondary">Выбрать файл</button>
          <button id="checkBtn" class="btn">Проверить</button>
          <button id="rushBtn" class="btn secondary" disabled>Ускорить (5 мин)</button>
        </div>

        <!-- Статус прогресса -->
        <div id="statusRow" class="row" style="gap:8px;align-items:center;display:none">
          <span id="statusDot" style="width:10px;height:10px;border-radius:50%;background:var(--muted);display:inline-block"></span>
          <span id="statusText" class="muted"></span>
        </div>

        <!-- Превью файла -->
        <div id="fileInfo" class="card" style="display:none;background:transparent;border-style:dashed">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="col" style="gap:2px">
              <div id="fileName" class="p"></div>
              <small id="fileMeta" class="muted"></small>
            </div>
            <button id="removeFile" class="btn secondary">Удалить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Результат / Что исправить / Извлечённые поля -->
    <div id="resultCard" class="card" style="margin-top:12px;display:none">
      <div class="h2">Результат</div>
      <div id="resultMsg" class="p"></div>

      <hr />

      <div class="h2">Что исправить</div>
      <ul id="issues" class="p" style="margin-top:4px"></ul>

      <hr />

      <div class="h2">Извлечённые поля</div>
      <!-- скрыто по дефолту, раскрывается пользователем -->
      <details id="extractedWrap" style="background:var(--ink);border:1px solid var(--line);border-radius:12px;">
        <summary id="extractedSummary" class="p" style="cursor:pointer;padding:12px">
          Показать извлечённые поля
        </summary>
        <div id="extracted" class="p" style="padding:12px;border-top:1px solid var(--line);white-space:pre-wrap"></div>
      </details>

      <small class="muted" style="display:block;margin-top:8px">Сообщение также придёт в бота.</small>
    </div>

  </div>

  <div class="tabs">
    <a class="tab" href="./translator.html">Переводчик</a>
    <a class="tab" href="./checklist.html">Чеклист</a>
    <a class="tab" href="./consultant.html">Консультант</a>
  </div>
</div>

<!-- Клиентский PDF-фоллбэк: рендер первой страницы PDF в PNG -->
<script src="./pdf-client-fallback.js" defer></script>

<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);

  // ===== helper =====
  function fmtBytes(n){
    if(!n && n!==0) return "";
    const u=["Б","КБ","МБ","ГБ"]; let i=0; let v=n;
    while(v>1024 && i<u.length-1){ v/=1024; i++; }
    return v.toFixed(v<10?1:0)+" "+u[i];
  }
  // ЧЕЛОВЕКОЧИТАЕМЫЙ вывод без кавычек/скобок
  function humanFields(fields){
    const map = {
      full_name: "ФИО",
      address: "Адрес",
      postal_code: "Индекс",
      city: "Город",
      doc_date: "Дата документа",
      valid_from: "Действует с",
      valid_to: "Действует до",
      issuer: "Орган, выдавший документ",
      signatures_present: "Подписи/печати"
    };
    const order = ["full_name","address","postal_code","city","doc_date","valid_from","valid_to","issuer","signatures_present"];
    const lines = [];
    order.forEach((k)=>{
      const label = map[k] || k;
      let val = fields && (fields[k]!==undefined ? fields[k] : null);
      if (val === null || val === undefined || val === "") val = "—";
      if (typeof val === "boolean") val = val ? "да" : "нет";
      lines.push(`${label}: ${val}`);
    });
    return lines.join("\n");
  }
  function verdictMessage(v, isProof){
    if(v==="fail") {
      if(isProof === false) return "Документ не является подтверждением адреса.";
      return "Документ содержит ошибки и не может быть принят.";
    }
    if(v==="pass") return "Документ подтверждает адрес проживания.";
    return "Не удалось уверенно определить корректность документа.";
  }
  function renderIssues(list){
    const box = $("#issues");
    box.innerHTML = "";
    if(!list || !list.length){
      const li = document.createElement("li");
      li.className = "muted";
      li.textContent = "Ошибок не найдено.";
      box.appendChild(li);
      return;
    }
    list.forEach(e=>{
      const li = document.createElement("li");
      const sev = e.severity ? String(e.severity).toUpperCase() : "";
      li.innerHTML = `<b>${e.title || "Ошибка"}</b> · ${sev}<br/><span class="muted">${e.detail || ""}</span>`;
      box.appendChild(li);
    });
  }

  // ===== статусная строка =====
  const statusRow = $("#statusRow");
  const statusDot = $("#statusDot");
  const statusText = $("#statusText");
  function setStatus(type, text){
    const color = type==="ok" ? "var(--ok)"
                : type==="warn" ? "var(--warn)"
                : type==="error" ? "var(--danger)"
                : type==="checking" ? "var(--warn)"
                : "var(--muted)";
    statusDot.style.background = color;
    statusText.textContent = text || "";
    statusRow.style.display = text ? "flex" : "none";
  }

  // ===== upload state =====
  let chosenFile = null;
  const fileInput = $("#file");
  const fileInfo = $("#fileInfo");
  const fileName = $("#fileName");
  const fileMeta = $("#fileMeta");

  $("#pickFileBtn").onclick = ()=> fileInput.click();

  fileInput.onchange = () => {
    const f = fileInput.files && fileInput.files[0];
    chosenFile = f || null;
    if (chosenFile){
      fileInfo.style.display = "block";
      fileName.textContent = chosenFile.name || "Файл";
      fileMeta.textContent = `${chosenFile.type || "—"} · ${fmtBytes(chosenFile.size||0)}`;
      setStatus("warn","Файл выбран — можно запустить проверку.");
    } else {
      fileInfo.style.display = "none";
      fileName.textContent = ""; fileMeta.textContent = "";
      setStatus(null,"");
      $("#resultCard").style.display = "none";
    }
  };
  $("#removeFile").onclick = () => {
    chosenFile = null;
    fileInput.value = "";
    fileInfo.style.display = "none";
    setStatus(null,"");
    $("#resultCard").style.display = "none";
  };

  // ===== check =====
  $("#checkBtn").onclick = async ()=>{
    // берём файл из клиентского PDF-фоллбэка (PNG для PDF) либо исходный
    const uploadFile = (window.emgrGetUploadFile && window.emgrGetUploadFile()) || chosenFile;

    if(!uploadFile){
      alert("Сначала загрузите файл.");
      return;
    }
    const docType = $("#docType").value || "other";
    const fd = new FormData();
    fd.append("docType", docType);
    fd.append("file", uploadFile, uploadFile.name || "document");

    $("#checkBtn").disabled = true;
    setStatus("checking","Проверяем…");

    try{
      const res = await fetch("/api/verify-address", { method:"POST", body: fd });
      const data = await res.json();

      // Результат — всегда есть
      const msg = verdictMessage(data.verdict, data.is_proof_of_address);
      $("#resultMsg").textContent = msg;

      // Ошибки — всегда показываем (или «Ошибок не найдено»)
      renderIssues(data.errors || []);

      // Извлечённые поля — человекочитаемые подписи
      const pretty = humanFields(data.fieldsExtracted || {});
      $("#extracted").textContent = pretty;

      // сворачиваем; юзер сам раскрывает
      const det = $("#extractedWrap");
      det.open = false;
      $("#extractedSummary").textContent = "Показать извлечённые поля";

      $("#resultCard").style.display = "block";

      if (data.verdict === "pass") setStatus("ok","Проверка пройдена");
      else if (data.verdict === "fail") setStatus("error","Есть ошибки");
      else setStatus("warn","Не удалось уверенно определить корректность");
    }catch(e){
      setStatus("error","Ошибка при проверке");
      alert("Не удалось проверить документ. Попробуйте ещё раз.");
    }finally{
      $("#checkBtn").disabled = false;
    }
  };

  // переключение текста summary при раскрытии
  const det = document.getElementById("extractedWrap");
  const sum = document.getElementById("extractedSummary");
  det?.addEventListener("toggle", ()=>{
    sum.textContent = det.open ? "Скрыть извлечённые поля" : "Показать извлечённые поля";
  });

  // TG init
  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg) { tg.expand(); tg.ready(); }
})();
</script>
</body>
</html>
