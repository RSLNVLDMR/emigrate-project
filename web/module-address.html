<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ ‚Äî eMigrant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .filecard{display:flex;align-items:center;gap:12px;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:transparent;max-width:100%}
    .filethumb{width:48px;height:48px;border-radius:8px;border:1px solid var(--line);background:var(--card);display:flex;align-items:center;justify-content:center;overflow:hidden;font-weight:700;color:var(--muted)}
    .xbtn{background:transparent;border:1px solid var(--line);border-radius:8px;padding:4px 8px;cursor:pointer;color:var(--muted)}
    details{border:1px solid var(--line);border-radius:12px;padding:12px;background:transparent}
    details>summary{cursor:pointer;font-weight:700;list-style:none}
    details>summary::-webkit-details-marker{display:none}
    .status{display:inline-flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--danger)}
    #resultBox{display:none}
    #resultBox.show{display:block}
    #errors li{margin:6px 0}
  </style>
</head>
<body>
<div class="screen">
  <div class="container">
    <div class="header">
      <div class="h1">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞</div>
      <div class="lang">
        <button data-lang="ru" class="active">RU</button>
        <button data-lang="ua">UA</button>
        <button data-lang="by">BY</button>
      </div>
    </div>

    <div class="card">
      <div class="h2">–ó–∞—á–µ–º –Ω—É–∂–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç</div>
      <p class="p">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∫–∞—Ä—Ç—ã –ø–æ–±—ã—Ç—É, –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞, –≤ ZUS/UrzƒÖd Skarbowy –∏ –¥—Ä. –ü–æ–¥–æ–π–¥—É—Ç: –º–µ–ª–¥—É–Ω–µ–∫ (za≈õwiadczenie o zameldowaniu), –¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã, –∞–∫—Ç –ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏/–ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è, –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ —Å –∑–∞—è–≤–ª–µ–Ω–∏–µ–º –∏ —Ç.–ø.</p>
    </div>

    <details open style="margin-top:12px">
      <summary>–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å</summary>
      <div class="col" style="margin-top:8px">
        <div class="item"><div class="badge">–°–∫–æ—Ä–æ</div><div>–£–º–æ–≤–∞ –Ω–∞–π–º—É (–æ–±—ã—á–Ω–∞—è) ‚Äî —Å—é–¥–∞ –¥–æ–±–∞–≤–∏–º –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.</div></div>
        <div class="item"><div class="badge">–°–∫–æ—Ä–æ</div><div>–£–º–æ–≤–∞ –Ω–∞–π–º—É okazjonalna ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –Ω—é–∞–Ω—Å—ã: –Ω–æ—Ç–∞—Ä–∏–∞–ª—å–Ω–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ, –∞–¥—Ä–µ—Å ¬´na wypadek¬ª –∏ –ø—Ä.</div></div>
        <div class="item"><div class="badge">–°–∫–æ—Ä–æ</div><div>–ú–µ–ª–¥—É–Ω–µ–∫ ‚Äî –≥–¥–µ –∏ –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≤ gmina/UM, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã —Å—Ç–æ—è—Ç—å –Ω–∞ —Å–ø—Ä–∞–≤–∫–µ.</div></div>
        <div class="item"><div class="badge">–°–∫–æ—Ä–æ</div><div>–í—ã ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ –∂–∏–ª—å—è (ksiƒôga wieczysta/–∞–∫—Ç) ‚Äî –∫–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è —É–∂–æ–Ω–¥–∞/–±–∞–Ω–∫–∞.</div></div>
        <small class="muted">–ú—ã –ø–æ–¥—Å—Ç–∞–≤–∏–º —Ç–æ—á–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏ –Ω—é–∞–Ω—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ—Å–ª–µ –∞–Ω–∫–µ—Ç—ã. –ü–æ–∫–∞ ‚Äî –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä.</small>
      </div>
    </details>

    <div class="card" style="margin-top:12px">
      <div class="h2">–£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</div>

      <label class="col" style="margin-bottom:8px">
        <span>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</span>
        <select id="docType" class="input">
          <option value="lease_standard">–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã (–æ–±—ã—á–Ω—ã–π)</option>
          <option value="lease_okazjonalna">–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã okazjonalna</option>
          <option value="meldunek">–ú–µ–ª–¥—É–Ω–µ–∫ (za≈õwiadczenie o zameldowaniu)</option>
          <option value="owner">–í—ã ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ –∂–∏–ª—å—è</option>
          <option value="other">–î—Ä—É–≥–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞</option>
        </select>
      </label>

      <div class="col" id="uploadZone">
        <small class="muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ PDF (–¥–æ 10 –ú–ë):</small>
        <div class="row" style="gap:8px">
          <input id="file" type="file" accept="application/pdf,image/*" hidden />
          <button id="pick" type="button" class="btn secondary">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        </div>
        <div id="preview"></div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px">
        <div class="status"><span class="dot" id="statusDot"></span><small id="statusText" class="muted">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞</small></div>
        <div class="row" style="gap:8px">
          <button id="run" class="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          <button id="speed" class="btn secondary" title="–û–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –ø–æ–∑–∂–µ" disabled>–£—Å–∫–æ—Ä–∏—Ç—å (5 –º–∏–Ω)</button>
        </div>
      </div>

      <div id="resultBox" class="card" style="margin-top:12px">
        <div class="h2" style="margin-top:0">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <p id="verdict" class="p"></p>
        <div id="blockErrors" class="col hidden">
          <div class="h2">–û—à–∏–±–∫–∏ –∏ –∑–∞–º–µ—á–∞–Ω–∏—è</div>
          <ul id="errors"></ul>
        </div>
        <div id="blockRecos" class="col hidden">
          <div class="h2">–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å</div>
          <ul id="recos"></ul>
        </div>
        <details style="margin-top:8px">
          <summary>–ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –ø–æ–ª—è</summary>
          <pre id="fields" style="white-space:pre-wrap;overflow-wrap:anywhere;margin:8px 0 0"></pre>
        </details>
        <small class="muted">–°–æ–æ–±—â–µ–Ω–∏–µ —Ç–∞–∫–∂–µ –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç–∞.</small>
      </div>

      <small class="muted" style="display:block;margin-top:8px">
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 24 —á–∞—Å–æ–≤. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã ‚Äî –¥–æ 5 –º–∏–Ω—É—Ç. (–û–ø–ª–∞—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ; –¥–ª—è —Ç–µ—Å—Ç–∞ –æ—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å—Ä–∞–∑—É.)
      </small>
    </div>
  </div>

  <div class="tabs">
    <a class="tab" href="./translator.html">–ü–µ—Ä–µ–≤–æ–¥—á–∏–∫</a>
    <a class="tab" href="./checklist.html">–ß–µ–∫–ª–∏—Å—Ç</a>
    <a class="tab" href="./consultant.html">–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</a>
  </div>
</div>

<script>
(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const MAX_MB=10;

  const tg=window.Telegram?.WebApp; if(tg){tg.expand(); tg.ready();}

  let selectedFile=null, previewUrl=null, cardEl=null;
  let busy=false;

  function humanSize(b){const mb=b/1024/1024; return mb>=1?mb.toFixed(2)+' MB':(b/1024).toFixed(0)+' KB';}
  function setStatus(type,text){
    $('#statusText').textContent=text||'';
    const d=$('#statusDot'); d.className='dot';
    if(type==='ok') d.classList.add('ok'); else if(type==='err') d.classList.add('err');
  }

  // —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫—É/–ø—Ä–µ–≤—å—é (–ù–ï —Ç—Ä–æ–≥–∞—è selectedFile –∏ input.value)
  function removeCardOnly(){
    if(cardEl){cardEl.remove();cardEl=null;}
    if(previewUrl){URL.revokeObjectURL(previewUrl);previewUrl=null;}
  }

  // –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–ø–æ –∫–Ω–æ–ø–∫–µ "–£–¥–∞–ª–∏—Ç—å")
  function clearPreview(){
    removeCardOnly();
    selectedFile=null;
    const inp=$('#file'); if(inp) inp.value='';
  }

  function makePreview(f){
    removeCardOnly(); // —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–æ—á–∫—É, —Ñ–∞–π–ª –æ—Å—Ç–∞–≤–ª—è–µ–º
    const card=document.createElement('div'); card.className='filecard';
    const thumb=document.createElement('div'); thumb.className='filethumb';
    const col=document.createElement('div'); col.className='col'; col.style.flex='1';
    const name=document.createElement('div'); name.className='p'; name.textContent=f.name;
    const meta=document.createElement('small'); meta.className='muted'; meta.textContent=(f.type||'binary')+' ¬∑ '+humanSize(f.size);
    const del=document.createElement('button'); del.className='xbtn'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.onclick=()=>{ clearPreview(); setStatus(null,'–§–∞–π–ª —É–¥–∞–ª—ë–Ω'); };
    if(f.type.startsWith('image/')){ previewUrl=URL.createObjectURL(f); thumb.innerHTML=`<img src="${previewUrl}" alt="preview" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`; } else { thumb.textContent='PDF'; }
    col.appendChild(name); col.appendChild(meta); card.appendChild(thumb); card.appendChild(col); card.appendChild(del);
    $('#preview').appendChild(card); cardEl=card;
  }

  // —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≥–µ—Ç—Ç–µ—Ä —Ñ–∞–π–ª–∞ (–∏–∑ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –ø—Ä—è–º–æ –∏–∑ input)
  function currentFile(){
    if (selectedFile) return selectedFile;
    const inp=$('#file');
    if (inp && inp.files && inp.files[0]) return inp.files[0];
    return null;
  }

  // bind upload
  $('#pick').onclick=()=>$('#file').click();
  $('#file').addEventListener('change',e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const ok=f.type.startsWith('image/') || f.type==='application/pdf';
    if(!ok){ alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –∏ PDF'); return; }
    if(f.size>MAX_MB*1024*1024){ alert('–§–∞–π–ª –±–æ–ª—å—à–µ '+MAX_MB+' –ú–ë'); return; }
    selectedFile=f;                // ‚¨ÖÔ∏è –°–ù–ê–ß–ê–õ–ê –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ñ–∞–π–ª
    makePreview(f);                // ‚¨ÖÔ∏è –∞ –ø—Ä–µ–≤—å—é –±–æ–ª—å—à–µ –ù–ï –æ–±–Ω—É–ª—è–µ—Ç selectedFile
    setStatus(null,'–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É');
  });

  function renderResult(data){
    const verdict=$('#verdict'); const errBlock=$('#blockErrors'); const recBlock=$('#blockRecos');
    verdict.textContent = data.message || (data.verdict==='pass'?'–î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç. –ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.':
                         data.verdict==='fail'?'–ï—Å—Ç—å –æ—à–∏–±–∫–∏ ‚Äî —Å–º. –Ω–∏–∂–µ.':'–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ—Ä–µ–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞.');
    // –æ—à–∏–±–∫–∏
    const errs=(data.errors||[]); const ulE=$('#errors'); ulE.innerHTML='';
    if(errs.length){ errBlock.classList.remove('hidden'); errs.forEach(e=>{
      const li=document.createElement('li'); li.innerHTML=`<b>${e.title||e.code||'–û—à–∏–±–∫–∞'}</b>${e.severity?' ¬∑ '+e.severity.toUpperCase():''}<br><small class="muted">${e.detail||''}</small>`;
      ulE.appendChild(li);
    }); } else errBlock.classList.add('hidden');
    // —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    const recs=(data.recommendations||[]); const ulR=$('#recos'); ulR.innerHTML='';
    if(recs.length){ recBlock.classList.remove('hidden'); recs.forEach(r=>{const li=document.createElement('li'); li.textContent=r; ulR.appendChild(li);});}
    else recBlock.classList.add('hidden');

    $('#fields').textContent = JSON.stringify(data.fieldsExtracted||{}, null, 2);
    $('#resultBox').classList.add('show');
  }

  async function verify(){
    if(busy) return;
    const f = currentFile();
    if(!f){ alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª'); return; }

    const fromSel = $('#docType').value;
    setStatus(null,'–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶');
    $('#resultBox').classList.remove('show');

    busy=true;
    $('#run').setAttribute('disabled','disabled');

    try{
      const fd=new FormData();
      fd.append('docType', fromSel);
      fd.append('file', f, f.name);

      const res=await fetch('/api/verify-address',{method:'POST',body:fd});
      const data=await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.error||'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

      renderResult(data);
      setStatus(data.verdict==='pass'?'ok':(data.verdict==='fail'?'err':null),
                data.verdict==='pass'?'–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞':(data.verdict==='fail'?'–ï—Å—Ç—å –æ—à–∏–±–∫–∏':'–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ'));
      // TODO: –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–∞
    }catch(e){
      console.error(e);
      setStatus('err','–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç');
      alert('–û—à–∏–±–∫–∞: '+(e.message||''));
    }finally{
      busy=false;
      $('#run').removeAttribute('disabled');
    }
  }

  $('#run').onclick=verify;
  $('#speed').onclick=()=>alert('–û–ø–ª–∞—Ç–∞ –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ–∑–∂–µ üôÇ');
})();
</script>
</body>
</html>
